---
import { getCollection } from "astro:content";
import { getLangFromUrl, useTranslations } from "../i18n/utils";
import { techIcons } from "../utils/techIcons";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Get all projects for the current language
const allProjects = await getCollection("projects", ({ data }) => {
  return data.lang === lang;
});

// Sort projects by order and get featured projects
const featuredProjects = allProjects
  .filter((project) => project.data.featured)
  .sort((a, b) => a.data.order - b.data.order)
  .slice(0, 3); // Show only 3 featured projects
---

<section id="projects" class="bg-white t-pad100 b-pad80">
  <div class="container">
    <div class="row">
      <div class="col-md-12 text-center b-pad60">
        <h2 class="heading">{t("projects.title")}</h2>
        <p class="h-sub">
          {t("projects.subtitle")}
        </p>
      </div>
    </div>

    <div class="row">
      {
        featuredProjects.map((project) => (
          <div class="col-md-4 b-mgr40">
            <div
              class="project-card"
              style="border: 1px solid #e5e5e5; border-radius: 8px; overflow: hidden;"
            >
              <div>
                <img
                  src={project.data.image}
                  alt={project.data.title}
                  style="width: 100%; height: 100%; object-fit: cover;"
                  loading="lazy"
                />
              </div>
              <div style="padding: 25px;">
                <h3 style="margin-bottom: 10px;">{project.data.title}</h3>
                <p style="color: #666; margin-bottom: 15px;">
                  {project.data.description}
                </p>
                
                {project.data.projects && project.data.projects.length > 0 && (
                  <div style="margin-bottom: 20px; border-top: 1px solid #e5e5e5; padding-top: 15px;">
                    <ul style="list-style: none; padding-left: 0; margin-bottom: 0;">
                      {project.data.projects.map((subproject) => (
                        <li style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px dashed #eee; &:last-child { border-bottom: none; }">
                          <div style="font-weight: 600; margin-bottom: 4px;">
                            {subproject.name}
                          </div>
                          {subproject.role && (
                            <div style="font-size: 13px; color: #666; margin-bottom: 8px;">
                              <span style="font-weight: 500;">Rol:</span> {subproject.role}
                            </div>
                          )}
                          {subproject.technologies && subproject.technologies.length > 0 && (
                            <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;">
                              {subproject.technologies.map((tech) => (
                                <span
                                  style="
                                    display: inline-flex;
                                    align-items: center;
                                    gap: 4px;
                                    padding: 3px 8px;
                                    background: #f0f5ff;
                                    border-radius: 4px;
                                    font-size: 12px;
                                    font-weight: 500;
                                    color: #2c3e50;
                                  "
                                >
                                  {techIcons[tech] && (
                                    <i
                                      class={techIcons[tech]}
                                      style="font-size: 14px;"
                                      title={tech}
                                    />
                                  )}
                                  {tech}
                                </span>
                              ))}
                            </div>
                          )}
                        </li>
                      ))}
                    </ul>
                  </div>
                )}
                {project.data.technologies && project.data.technologies.filter(t => t).length > 0 && (
                  <div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 8px;">
                    <h4 style="width: 100%; font-size: 14px; margin-bottom: 8px; color: #333; font-weight: 600;">
                    </h4>
                    {project.data.technologies.filter(t => t).map((tech) => (
                      <div
                        style="
                          display: flex;
                          align-items: center;
                          gap: 6px;
                          padding: 6px 10px;
                          background: #f4f6f8;
                          border-radius: 6px;
                          font-size: 13px;
                          font-weight: 500;
                        "
                      >
                        {techIcons[tech] && (
                          <i
                            class={techIcons[tech]}
                            style="font-size: 18px;"
                            title={tech}
                          />
                        )}
                        <span>{tech}</span>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          </div>
        ))
      }
    </div>

    <div class="row">
      <div class="col-md-12 text-center t-mgr40">
        <!-- <a href={`/${lang}/projects`} class="btn btn-white-brd large">
          {t("projects.viewAll")}
          <i class="arrow_right">&rarr;</i>
        </a> -->
      </div>
    </div>
  </div>
</section>