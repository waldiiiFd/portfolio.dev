<section id="contact" class="bg-white t-pad100 b-pad80">
  <div class="container">
    <!-- Section Header-->
    <div class="row">
      <div class="col-md-12 text-center b-pad60">
        <h2 class="heading">Let's Work Together</h2>
        <p class="h-sub">
          I'm always interested in hearing about new projects and opportunities.
        </p>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6 col-md-offset-3">
        <!-- Status Messages-->
        <div id="message-container"></div>

        <!-- Form-->
        <form id="contact-form" class="contact-form">
          <!-- Name Field-->
          <div class="form-group">
            <input
              type="text"
              id="name"
              class="form-control"
              placeholder="Your Name"
              required
              minlength="3"
              maxlength="50"
            />
          </div>

          <!-- Email Field-->
          <div class="form-group">
            <input
              type="email"
              id="email"
              class="form-control"
              placeholder="Your Email"
              required
            />
          </div>

          <!-- Subject Field-->
          <div class="form-group">
            <input
              type="text"
              id="subject"
              class="form-control"
              placeholder="Subject"
              required
              minlength="5"
              maxlength="100"
            />
          </div>

          <!-- Message Field-->
          <div class="form-group">
            <textarea
              id="message"
              class="form-control"
              rows="5"
              placeholder="Your Message"
              required
              minlength="10"
              maxlength="1000"></textarea>
          </div>

          <!-- Submit Button Field-->
          <div class="text-center">
            <button type="submit" class="btn large" id="submit-btn">
              Send Message <i class="arrow_right">&rarr;</i>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

<style>
  #message-container {
    margin-bottom: 20px;
  }

  .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  @keyframes slideOut {
    from {
      opacity: 1;
      transform: translateY(0);
    }
    to {
      opacity: 0;
      transform: translateY(-10px);
    }
  }

  .alert-auto-close {
    animation: slideOut 0.3s ease-in-out forwards !important;
  }
</style>

<script>
  import emailjs from "emailjs-com";

  const EMAIL_SERVICE_ID = import.meta.env.PUBLIC_EMAILJS_SERVICE_ID;
  const EMAIL_TEMPLATE_ID = import.meta.env.PUBLIC_EMAILJS_TEMPLATE_ID;
  const EMAIL_PUBLIC_KEY = import.meta.env.PUBLIC_EMAILJS_PUBLIC_KEY;

  // Validate environment variables
  if (!EMAIL_SERVICE_ID || !EMAIL_TEMPLATE_ID || !EMAIL_PUBLIC_KEY) {
    console.error(
      "Email configuration is missing. Please check your .env file"
    );
  }

  emailjs.init(EMAIL_PUBLIC_KEY);

  // Define form data interface
  interface FormData {
    name: string;
    email: string;
    subject: string;
    message: string;
  }

  // Get form and message container elements
  const form = document.getElementById("contact-form") as HTMLFormElement;
  const messageContainer = document.getElementById(
    "message-container"
  ) as HTMLDivElement;
  const submitBtn = document.getElementById("submit-btn") as HTMLButtonElement;

  // Function to show messages
  function showMessage(
    type: "success" | "danger" | "warning" | "info",
    text: string,
    autoClose: boolean = true
  ): void {
    const titles: Record<string, string> = {
      success: "Success!",
      danger: "Error!",
      warning: "Warning!",
      info: "Notice!",
    };

    const displayTitle = titles[type];

    const colors: Record<
      string,
      { bg: string; border: string; color: string }
    > = {
      success: { bg: "#d4edda", border: "#c3e6cb", color: "#155724" },
      danger: { bg: "#f8d7da", border: "#f5c6cb", color: "#721c24" },
      warning: { bg: "#fff3cd", border: "#ffeeba", color: "#856404" },
      info: { bg: "#d1ecf1", border: "#bee5eb", color: "#004085" },
    };

    const colorScheme = colors[type];

    messageContainer.innerHTML = `
      <div class="alert alert-${type}" style="
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid ${colorScheme.border};
        border-radius: 4px;
        background-color: ${colorScheme.bg};
        color: ${colorScheme.color};
        animation: slideIn 0.3s ease-in-out;
      ">
        <strong>${displayTitle}</strong> ${text}
      </div>
    `;

    if (autoClose) {
      setTimeout(() => {
        const alertEl = messageContainer.querySelector(".alert") as HTMLElement;
        if (alertEl) {
          alertEl.classList.add("alert-auto-close");
          setTimeout(() => {
            messageContainer.innerHTML = "";
          }, 300);
        }
      }, 5000);
    }
  }

  // Clear form
  function clearForm(): void {
    form.reset();
  }

  // Handle form submission
  form.addEventListener("submit", async (e: Event) => {
    e.preventDefault();

    const formData: FormData = {
      name: (document.getElementById("name") as HTMLInputElement).value,
      email: (document.getElementById("email") as HTMLInputElement).value,
      subject: (document.getElementById("subject") as HTMLInputElement).value,
      message: (document.getElementById("message") as HTMLTextAreaElement)
        .value,
    };

    showMessage("info", "Sending your message...", false);
    submitBtn.disabled = true;

    try {
      await emailjs.send(EMAIL_SERVICE_ID, EMAIL_TEMPLATE_ID, {
        to_email: import.meta.env.PUBLIC_RECIPIENT_EMAIL,
        from_name: formData.name,
        from_email: formData.email,
        subject: formData.subject,
        message: formData.message,
        reply_to: formData.email,
      });

      showMessage(
        "success",
        "Message sent successfully! I'll get back to you soon.",
        true
      );
      clearForm();
    } catch (error) {
      console.error("Error sending email:", error);
      showMessage(
        "danger",
        "There was an error sending your message. Please try again later.",
        true
      );
    } finally {
      submitBtn.disabled = false;
    }
  });
</script>
