---
import { languages } from "../i18n/ui";
import { getLangFromUrl } from "../i18n/utils";

const lang = getLangFromUrl(Astro.url);
const currentPath = Astro.url.pathname.split("/").slice(2).join("/") || "";
---

<li class="lang-switcher-container">
  <a href="#" class="white lang-toggle" aria-label="Language switcher">
    <i class="icon-picons-globe"></i>
    <span class="current-lang">{lang.toUpperCase()}</span>
    <i class="icon-down-dir"></i>
  </a>
  <div class="lang-dropdown">
    {
      Object.entries(languages).map(([code, name]) => (
        <a
          href={`/${code}${currentPath ? "/" + currentPath : ""}`}
          class={`lang-option ${code === lang ? "active" : ""}`}
          data-lang={code}
        >
          <span class="flag">{code === "en" ? "EN" : "ES"}</span>
          {name}
        </a>
      ))
    }
  </div>
</li>

<style>
  .lang-switcher-container {
    position: relative;
    display: flex;
    align-items: center;
  }

  .lang-toggle {
    display: flex;
    align-items: center;
    gap: 6px;
    text-decoration: none;
    transition: opacity 0.3s ease;
    cursor: pointer;
    padding: 10px 15px;
    color: white;
  }

  .lang-toggle:hover {
    opacity: 0.8;
  }

  .lang-toggle i:first-child {
    font-size: 16px;
  }

  .lang-toggle i:last-child {
    font-size: 10px;
    transition: transform 0.3s ease;
  }

  .current-lang {
    font-weight: 600;
    letter-spacing: 0.5px;
    font-size: 14px;
  }

  .lang-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    background: white;
    border: 1px solid #e5e5e5;
    border-radius: 6px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    min-width: 160px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s ease;
    z-index: 1000;
    overflow: hidden;
    pointer-events: none;
  }

  @media (max-width: 768px) {
    .lang-switcher-container {
      width: 100%;
      position: static;
    }

    .lang-toggle {
      width: 100%;
      justify-content: center;
      padding: 12px 15px;
    }

    .lang-dropdown {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-10px);
      right: auto;
      max-width: 250px;
    }

    .lang-dropdown.open {
      transform: translateX(-50%) translateY(0);
    }
  }

  .lang-option {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    color: #333;
    text-decoration: none;
    transition: all 0.2s ease;
    border-bottom: 1px solid #f0f0f0;
    font-size: 13px;
    white-space: nowrap;
  }

  @media (max-width: 768px) {
    .lang-option {
      padding: 12px 16px;
      font-size: 14px;
      justify-content: center;
    }
  }

  .lang-option:last-child {
    border-bottom: none;
  }

  .lang-option .flag {
    font-size: 18px;
    line-height: 1;
  }

  .lang-option:hover {
    background: #f8f8f8;
    padding-left: 18px;
  }

  .lang-option.active {
    background: var(--main-color, #3498db);
    color: white;
    font-weight: 600;
  }

  .lang-option.active:hover {
    background: var(--main-color, #2980b9);
    padding-left: 14px;
  }

  .lang-dropdown.open {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    pointer-events: auto;
  }

  .lang-toggle.open i:last-child {
    transform: rotate(180deg);
  }
</style>

<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    const langToggle = document.querySelector(".lang-toggle");
    const langDropdown = document.querySelector(".lang-dropdown");
    const container = document.querySelector(".lang-switcher-container");

    if (langToggle && langDropdown && container) {
      // Toggle on click
      langToggle.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();

        const isOpen = langDropdown.classList.contains("open");

        // Close all other dropdowns
        document.querySelectorAll(".lang-dropdown.open").forEach((dropdown) => {
          if (dropdown !== langDropdown) {
            dropdown.classList.remove("open");
            dropdown.previousElementSibling?.classList.remove("open");
          }
        });

        if (isOpen) {
          langDropdown.classList.remove("open");
          langToggle.classList.remove("open");
        } else {
          langDropdown.classList.add("open");
          langToggle.classList.add("open");
        }
      });

      // Hover effect for desktop
      if (window.innerWidth > 768) {
        container.addEventListener("mouseenter", () => {
          langDropdown.classList.add("open");
          langToggle.classList.add("open");
        });

        container.addEventListener("mouseleave", () => {
          langDropdown.classList.remove("open");
          langToggle.classList.remove("open");
        });
      }

      // Close on click outside
      document.addEventListener("click", (e) => {
        if (!container.contains(e.target)) {
          langDropdown.classList.remove("open");
          langToggle.classList.remove("open");
        }
      });

      // Close on Escape key
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          langDropdown.classList.remove("open");
          langToggle.classList.remove("open");
        }
      });

      // Close on mobile when selecting a language
      langDropdown.querySelectorAll(".lang-option").forEach((option) => {
        option.addEventListener("click", () => {
          langDropdown.classList.remove("open");
          langToggle.classList.remove("open");
        });
      });
    }
  });
</script>
